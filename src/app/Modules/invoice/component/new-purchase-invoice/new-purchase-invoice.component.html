<app-loading *ngIf="publicVariable.isProcess"></app-loading>

<div class="inner-content">
    <h3 class="content-title">PI New Purchase Invoice</h3>

    <form [formGroup]="publicVariable.dataForm">
        <input type="hidden" formControlName="headerid">
        <div class="pipage-radio">
            <div class="form-check">
                <input class="form-check-input" formControlName="ImpiHeaderInvoiceType" type="radio"
                    name="ImpiHeaderInvoiceType" id="flexRadioDefault1" value="Proforma Invoice" />
                <label class="form-check-label" for="flexRadioDefault1">
                    Proforma Invoice
                </label>
            </div>

            <div class="form-check">
                <input class="form-check-input" formControlName="ImpiHeaderInvoiceType" type="radio"
                    name="ImpiHeaderInvoiceType" id="flexRadioDefault2" value="Tax Invoice" />
                <label class="form-check-label" for="flexRadioDefault2">
                    Tax Invoice
                </label>
            </div>
        </div>

        <div class="mastersform-sec mb-0">
            <div class="row">
                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="projectCode">Project Code</label>
                        <ng-select [items]="publicVariable.projectList" #select bindLabel="code" bindValue="code"
                            placeholder="Select in Project Code" formControlName="ImpiHeaderProjectCode"
                            (change)="onSelectProject()" [searchable]="true" [searchFn]="customSearchFn"
                            [virtualScroll]="true" [bufferAmount]="10">

                            <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                                <small>{{item.code}} - {{item.name}}</small>
                            </ng-template>
                        </ng-select>
                        <div *ngIf="shouldShowError('ImpiHeaderProjectCode','required')" class="text-danger">This field
                            is required
                        </div>

                    </div>
                </div>

                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="Project">Project</label>
                        <input type="text" id="Project" placeholder="Project" formControlName="Project"
                            class="form-control" />
                        <div *ngIf="shouldShowError('Project','required')" class="text-danger">This field
                            is required
                        </div>

                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="department">Department</label>
                        <input type="text" id="department" placeholder="Department"
                            formControlName="ImpiHeaderDepartment" class="form-control" />
                        <div *ngIf="shouldShowError('ImpiHeaderDepartment','required')" class="text-danger">This field
                            is required
                        </div>

                    </div>
                </div>

                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="division">Division</label>
                        <input type="text" id="division" placeholder="Division" formControlName="ImpiHeaderDivison"
                            class="form-control" />
                        <div *ngIf="shouldShowError('ImpiHeaderDivison','required')" class="text-danger">This field is
                            required
                        </div>

                    </div>
                </div>

                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="PANNo">PAN No</label>
                        <input type="text" id="PANNo" class="form-control" placeholder="PAN No"
                            formControlName="ImpiHeaderPanNo" />
                        <div *ngIf="shouldShowError('ImpiHeaderPanNo','invalidPAN')" class="text-danger">Please enter a
                            valid PAN Number.
                        </div>
                    </div>
                </div>


                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label>GST No</label>
                        <input type="text" placeholder="GST No" class="form-control"
                            formControlName="ImpiHeaderGstNo" />

                        <div *ngIf="shouldShowError('ImpiHeaderGstNo','invalidGST')" class="text-danger"> Please enter
                            a valid GST Registration Number. (05AAACF1282E1Z5)</div>

                    </div>
                </div>

                <!-- show tax-invoice-only -->
                <div class="col-md-4 col-sm-6"
                    *ngIf="publicVariable.dataForm.get('ImpiHeaderInvoiceType')?.value === 'Tax Invoice'">
                    <div class="form-group">
                        <label>PI No</label>
                        <input type="text" placeholder="PI No" class="form-control" formControlName="PINO" />
                    </div>
                </div>


            </div>
        </div>
        <div class="pi-pagetitle">Customer Details</div>

        <div class="mastersform-sec mb-0">
            <div class="row">
                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="CustomerName">Customer Name</label>
                        <div class="flex-field">
                            <ng-select [items]="publicVariable.GetCustomerList" #select class="w-100"
                                bindLabel="custName" bindValue="custName" placeholder="Select customer"
                                formControlName="ImpiHeaderCustomerName" (change)="onSelectCustomer()"
                                [searchable]="true" [searchFn]="customerSearchFn" [virtualScroll]="true"
                                [bufferAmount]="10">
                                <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                                    <div><span>{{item.custNo}}</span> - <span>{{item.custName | titlecase}}</span></div>
                                    <small *ngIf="item.panNo || item.gstregistrationNo">{{item.panNo}} -
                                        {{item.gstregistrationNo}}</small>
                                </ng-template>
                            </ng-select>

                            <div class="add-btn"><a routerLink="/customer/new" target="_blank">+</a></div>
                        </div>
                        <div *ngIf="shouldShowError('ImpiHeaderCustomerName','required')" class="text-danger">This field
                            is required
                        </div>
                    </div>
                </div>

                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="address">Address</label>
                        <input type="text" id="address" placeholder="Address"
                            formControlName="ImpiHeaderCustomerAddress" class="form-control" />
                        <div *ngIf="shouldShowError('ImpiHeaderCustomerAddress','required')" class="text-danger">This
                            field is required</div>

                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="state">State</label>
                        <ng-select [items]="publicVariable.stateList" #select bindLabel="stateName"
                            bindValue="stateCode" placeholder="Select " formControlName="ImpiHeaderCustomerState"
                            [searchable]="true" [searchFn]="stateSearchFn" [virtualScroll]="true" [bufferAmount]="10">
                            <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                                <small>{{item.stateCode}} - {{item.stateName}}</small>
                            </ng-template>
                        </ng-select>
                        <div *ngIf="shouldShowError('ImpiHeaderCustomerState','required')" class="text-danger">This
                            field is required</div>

                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" class="form-control" id="city" placeholder="city"
                            formControlName="ImpiHeaderCustomerCity" />
                        <div *ngIf="shouldShowError('ImpiHeaderCustomerCity','required')" class="text-danger">This field
                            is required
                        </div>

                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="pincode">Pincode</label>
                        <input type="text" formControlName="ImpiHeaderCustomerPinCode" placeholder="Pincode"
                            (input)="onInputChange($event)" class="form-control" />
                        <div *ngIf="shouldShowError('ImpiHeaderCustomerPinCode','required')" class="text-danger"> Pin
                            Code is
                            required.
                        </div>
                        <div *ngIf="shouldShowError('ImpiHeaderCustomerPinCode','pattern')" class="text-danger"> Please
                            enter a valid 6-digit Pin Code.</div>
                    </div>
                </div>

                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="GSTNumber">GST Number</label>
                        <input type="text" class="form-control" id="GSTNumber" placeholder="GST Number"
                            formControlName="ImpiHeaderCustomerGstNo" />
                        <div *ngIf="shouldShowError('ImpiHeaderCustomerGstNo','invalidGST')" class="text-danger"> Please
                            enter a valid GST Registration Number. (05AAACF1282E1Z5)</div>
                    </div>
                </div>

                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="ContactPerson">Contact Person</label>
                        <input type="text" placeholder="Contact Person" id="ContactPerson"
                            formControlName="ImpiHeaderCustomerContactPerson" class="form-control" />
                        <div *ngIf="shouldShowError('ImpiHeaderCustomerContactPerson', 'alphanumericWithSpaces')"
                            class="text-danger">
                            Please enter a valid alphanumeric value.
                        </div>

                    </div>
                </div>

                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="EmailID">Email ID</label>
                        <input type="text" placeholder="Email ID" id="EmailID"
                            formControlName="ImpiHeaderCustomerEmailId" class="form-control" />
                        <div *ngIf="shouldShowError('ImpiHeaderCustomerEmailId','required')" class="text-danger">Email
                            is required.
                        </div>
                        <div *ngIf="shouldShowError('ImpiHeaderCustomerEmailId','email')" class="text-danger"> Please
                            enter a valid email address.</div>
                    </div>
                </div>

                <div class="col-md-4 col-sm-6">
                    <div class="form-group">
                        <label for="PhoneNo">Phone No.</label>
                        <input type="text" class="form-control" id="PhoneNo" (input)="onInputChange($event)"
                            placeholder="Phone No" formControlName="ImpiHeaderCustomerPhoneNo" />
                        <div *ngIf="shouldShowError('ImpiHeaderCustomerPhoneNo','required')" class="text-danger">Phone
                            number is required.</div>
                        <div *ngIf="shouldShowError('ImpiHeaderCustomerPhoneNo','pattern')" class="text-danger">Invalid
                            phone number.</div>

                    </div>
                </div>
            </div>
        </div>

        <div class="pi-pagetitle">Sales Line</div>

        <div class="mastersform-sec mb-0">
            <form [formGroup]="publicVariable.expenseForm" (ngSubmit)="onAddLine()">
                <div class="row">
                    <div class="col-md-4 col-sm-6">
                        <div class="form-group">
                            <label>Nature of Expense</label>
                            <ng-select [items]="publicVariable.COAMasterList" #select bindLabel="name" bindValue="name"
                                placeholder="Select " [searchable]="true" [virtualScroll]="true" [bufferAmount]="10"
                                formControlName="natureOfExpense">
                            </ng-select>
                            <div *ngIf="shouldShowExpenseError('natureOfExpense','required')" class="text-danger">This
                                field is required</div>
                        </div>
                    </div>

                    <div class="col-md-4 col-sm-6">
                        <div class="form-group">
                            <label for="Quantity">Quantity</label>
                            <input type="text" class="form-control" id="Quantity" placeholder="Quantity"
                                formControlName="quantity" />
                            <div *ngIf="shouldShowExpenseError('quantity','required')" class="text-danger">This field is
                                required</div>

                        </div>
                    </div>

                    <div class="col-md-4 col-sm-6">
                        <div class="form-group">
                            <label>GST Group Code</label>
                            <ng-select [items]="publicVariable.GSTGroupList" #select bindLabel="code" bindValue="code"
                                placeholder="Select " [searchable]="true" [virtualScroll]="true" [bufferAmount]="10"
                                (change)="onGSTGroupChange($event)" formControlName="gstGroupCode">
                            </ng-select>
                            <div *ngIf="shouldShowExpenseError('gstGroupCode','required')" class="text-danger">This
                                field is
                                required</div>
                        </div>
                    </div>

                    <div class="col-md-4 col-sm-6">
                        <div class="form-group">
                            <label>HSN/SAC Code</label>
                            <ng-select [items]="publicVariable.HSNSACList" #select bindLabel="hsnCode"
                                bindValue="hsnCode" placeholder="Select " [searchable]="true" [virtualScroll]="true"
                                [bufferAmount]="10" formControlName="hsnCode">
                                <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                                    <small>{{item.hsnCode}} - {{item.hsnGroup}}</small>
                                </ng-template>
                            </ng-select>
                            <div *ngIf="shouldShowExpenseError('hsnCode','required')" class="text-danger">This field is
                                required</div>
                        </div>
                    </div>

                    <div class="col-md-4 col-sm-6">
                        <div class="form-group">
                            <label>Direct Unit Cost</label>
                            <input type="text" class="form-control" placeholder="Direct Unit Cost"
                                formControlName="unitCost">
                            <div *ngIf="shouldShowExpenseError('unitCost','required')" class="text-danger">This field is
                                required</div>
                        </div>
                    </div>

                    <div class="col-md-4 col-sm-6">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="common-btn w-auto"
                                type="submit">{{ isEditing ? 'Update Line' : 'Add Line' }}</button>

                        </div>
                    </div>
<!--
                    <div class="col-md-4 col-sm-6" *ngIf="publicVariable.expenses.length > 0">
                        <div class="form-group">
                            <label>(Total Base Amount)</label>
                            <input type="text" class="form-control" [value]="calculateTotalBaseAmount()"
                                placeholder="Total Base Amount" disabled="">
                        </div>
                    </div>

                    <div class="col-md-4 col-sm-6" *ngIf="publicVariable.expenses.length > 0">
                        <div class="form-group">
                            <label>(Total GST Amount)</label>
                            <input type="text" class="form-control" [value]="calculateTotalGSTAmount()"
                                placeholder="Total GST Amount" disabled="">
                        </div>
                    </div>

                    <div class="col-md-4 col-sm-6" *ngIf="publicVariable.expenses.length > 0">
                        <div class="form-group">
                            <label>(Net total)</label>
                            <input type="text" class="form-control" [value]="calculateNetTotal()"
                                placeholder="Net total" disabled="">
                        </div>
                    </div> -->

                </div>
            </form>

        </div>
        <div class="dasboard-table pi-table mb-0" *ngIf="publicVariable.expenses.length > 0">

            <div class="table-responsive">

                <table class="table table-bordered text-nowrap">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Line No</th>
                            <th width="38%">Nature of Expense</th>
                            <th>Quantity</th>
                            <th>Direct Unit Cost</th>
                            <th>Line Amount</th>
                            <th>GST Group Code</th>
                            <th>HSN/SAC Code</th>
                            <!-- <th>GST Base Amount</th>
                            <th>GST Amount</th> -->
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>

                        <tr *ngFor="let e of publicVariable.expenses; let i = index">
                            <td>{{i + 1}}</td>
                            <td></td>
                            <td>{{e.natureOfExpense }}</td>
                            <td>{{e.quantity}}</td>
                            <td>{{e.unitCost}}</td>
                            <td>{{e.quantity * e.unitCost}}</td>
                            <td>{{e.gstGroupCode }}</td>
                            <td>{{e.hsnCode}}</td>
                            <!-- <td>{{ calculateGSTBaseAmount(e) }}</td>
                            <td>{{ calculateGSTAmount(e) }}</td> -->
                            <td><span class="table-btns">
                                    <a href="javascript:void(0)" (click)="editExpense(e,i)"><img
                                            src="../assets/images/edit-icon.svg" alt=""></a>
                                    <a href="javascript:void(0)" (click)="deleteExpense(i)" data-bs-toggle="modal"
                                        data-bs-target="#deleterecord-modal">
                                        <img src="../assets/images/delete-icon.svg" alt="">
                                    </a>
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>

            </div>

        </div>
        <div class="text-end" *ngIf="publicVariable.expenses.length > 0"><a href="javascript:void(0)"
                (click)="onCalculateClick()" class="common-btn w-auto">Calculate</a></div>
        <div class="note-para">
            <p>Upload Only Digitally Signed Attachments (Sales Invoice, Purchase Order, Challan,
                Sample Copy, Other Documents)* <span class="text-danger">(Max File Size 5 MB
                    only)</span></p>
        </div>

        <div class="col-md-9 col-xs-12 col-sm-12 attach-col">
            <div class="row align-items-center">
                <div class="col-sm-2"><b>Attachment</b></div>
                <div class="col-sm-3 text-sm-end">Upload Document</div>
                <div class="col-sm-6">
                    <div class="input-group">
                        <input type="file" class="form-control" id="inputGroupFile02" accept=".pdf,.xlsx,.csv"
                            (change)="onFileSelected($event)" />
                        <label class="input-group-text" for="inputGroupFile02">Upload</label>
                    </div>
                </div>
            </div>
        </div>


        <div class="dasboard-table pi-table mb-0">

            <div class="table-responsive">

                <table class="table table-bordered text-nowrap">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>File Type</th>
                            <th>File Name</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td>
                                <a href="javascript:void(0)"><img src="../assets/images/download-icon.svg" alt="" class="me-2"></a>
                                <a href="javascript:void(0)" data-bs-toggle="modal"
                                    data-bs-target="#deleterecord-modal"><img src="../assets/images/delete-icon.svg"
                                        alt=""></a>
                            </td>
                        </tr>
                    </tbody>
                </table>

            </div>

        </div>
        <div class="mastersform-sec mb-3">
            <div class="col-md-9 mt-4">
                <div class="form-group">
                    <label for="PaymentTerms">Payment Terms</label>
                    <textarea class="form-control h-100" cols="2" rows="3" id="PaymentTerms"
                        formControlName="ImpiHeaderPaymentTerms"></textarea>
                </div>
            </div>

            <div class="col-md-9 mt-3">
                <div class="form-group">
                    <label for="Remarks">Remarks</label>
                    <textarea class="form-control h-100" cols="2" rows="3" id="Remarks"
                        formControlName="ImpiHeaderRemarks"></textarea>
                </div>
            </div>

            <div class="col-md-12">
                <div class="form-group mb-0 mt-4">
                    <input type="checkbox" class="btn-check" formControlName="IsDraft" id="btn-check"
                        autocomplete="off">
                    <label class="btn btn-secondary w-auto mb-0 me-2" for="btn-check" (click)="onSubmit(true)">Save as
                        Draft</label>
                    <button type="submit" class="common-btn w-auto" (click)="onSubmit(false)">Submit</button>
                </div>
            </div>
        </div>
    </form>

</div>
